<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Episode Timing Table</title>



<script>

function getUTCDateTime() {
    const now = new Date();

    const year = now.getUTCFullYear();
    const month = (now.getUTCMonth() + 1).toString().padStart(2, '0'); 
    const day = now.getUTCDate().toString().padStart(2, '0');
    const hours = now.getUTCHours().toString().padStart(2, '0');
    const minutes = now.getUTCMinutes().toString().padStart(2, '0');
    const seconds = now.getUTCSeconds().toString().padStart(2, '0');

    // Return the formatted UTC datetime string
    return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
}

async function fetchUTCTime() {
    try {
        const response = await fetch('http://worldtimeapi.org/api/timezone/Etc/UTC');
        const data = await response.json();
        const utcDateTime = data.datetime; // This returns the datetime in ISO 8601 format

        // Extract the date and time in the desired format
        const year = utcDateTime.slice(0, 4);
        const month = utcDateTime.slice(5, 7);
        const day = utcDateTime.slice(8, 10);
        const time = utcDateTime.slice(11, 19); // This includes hours, minutes, and seconds

        // Return the formatted UTC datetime string
        console.log(`${year}-${month}-${day}T${time}`)
        return `${year}-${month}-${day}T${time}`;
    } catch (error) {
        console.error('Failed to fetch UTC time:', error);
        return null; // Return null or handle the error appropriately
    }
}


    document.addEventListener('DOMContentLoaded', function() {
              
        const form =  document.getElementById('form');

        window.handleStartButton = function() {  
            event.preventDefault();
            fetchUTCTime().then(utcTime => {
                const startTimeInput = document.querySelector('input[name="startTime"]');
                startTimeInput.value = utcTime;
                form.submit();
            });           
        };

        window.handleSplit1 = function() {
            event.preventDefault();
            const endTimeInputs = document.querySelectorAll('input[name^="team1_endtime"]');

            // Find the first input that is empty and set it with the current UTC time
            for (let input of endTimeInputs) {
                if (!input.value) {                     
                    fetchUTCTime().then(utcTime => {                        
                        input.value = getUTCDateTime(utcTime);
                        form.submit();
                    });                       
                    break; 
                }
            }
        };

        window.handleSplit2 = function() {
            event.preventDefault();
            const endTimeInputs = document.querySelectorAll('input[name^="team2_endtime"]');

            // Find the first input that is empty and set it with the current UTC time
            for (let input of endTimeInputs) {
                if (!input.value) { 
                    fetchUTCTime().then(utcTime => {                        
                        input.value = getUTCDateTime(utcTime);
                        form.submit();
                    });                     
                    break; 
                }
            }
        };

        window.handleSplit3 = function() {
            event.preventDefault();
            const endTimeInputs = document.querySelectorAll('input[name^="team3_endtime"]');

            // Find the first input that is empty and set it with the current UTC time
            for (let input of endTimeInputs) {
                if (!input.value) { 
                    fetchUTCTime().then(utcTime => {                        
                        input.value = getUTCDateTime(utcTime);
                    });                     
                    break; 
                }
            }
        };      
       
      
    });
    </script>



    
</head>
<body>
    <h1>Enter Run Data</h1>

    
    <form action="{{ url_for('command') }}" method="post" id="form">


        Start Time: <input type="datetime-local" name="startTime" step="1"
        value="{{ data.get('start_time', '').replace('Z', '').split('.')[0] }}">

        <button id="startButton" onclick="handleStartButton()">Start Timer</button>
        <br> 
        <br>
        <br>
        <table id="commandTable" style="text-align: center;"> 
            <tr>
                <th>Episode</th>
                <th>Team 1</th>
                <th>Team 2</th>
                <th>Team 3</th>               
            </tr>
            {% for i in [1, 2, 4, 6, 3, 5] %}
            <tr>
                <td>E{{ i }}</td>
                {% for team_num in range(1, 4) %}                
                <td>
                    Runner: <input type="text" name="team{{ team_num }}_runner{{ i }}"
                        value="{{ data.get('team{}'.format(team_num), {}).get('E{}'.format(i), {}).get('runner', '') }}" required>
                    End Time: <input type="datetime-local" step="1" name="team{{ team_num }}_endtime{{ i }}"
                        value="{{ data.get('team{}'.format(team_num), {}).get('E{}'.format(i), {}).get('end_time', '').replace('Z', '').split('.')[0] }}">
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
            <tr>
                <td>
                    <input type="submit" value="Save Data">
                </td>
                <td>
                   <button id="split1" onclick="handleSplit1()">Split Team 1</button> 
                </td>
                <td>
                    <button id="split2" onclick="handleSplit2()">Split Team 2</button>
                </td>
                <td>
                   <button id="split3" onclick="handleSplit3()">Split Team 3</button> 
                </td>
                
            </tr>
        </table>
        
    </form>
</body>
</html>
